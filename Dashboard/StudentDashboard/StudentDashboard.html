<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - University Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      body {
        font-family: "Inter", sans-serif;
        transition:
          background-color 0.3s,
          color 0.3s;
      }

      /* Dark Mode */
      body.dark-mode {
        background-color: #111827;
        color: #f3f4f6;
      }
      body.dark-mode .bg-white {
        background-color: #1f2937;
        color: #f3f4f6;
        border-color: #374151;
      }
      body.dark-mode .bg-gray-50 {
        background-color: #111827;
      }
      body.dark-mode .bg-gray-100 {
        background-color: #374151;
        color: #e5e7eb;
      }
      body.dark-mode .text-gray-800 {
        color: #f9fafb;
      }
      body.dark-mode .text-gray-700 {
        color: #e5e7eb;
      }
      body.dark-mode .text-gray-600 {
        color: #d1d5db;
      }
      body.dark-mode .text-gray-500 {
        color: #9ca3af;
      }
      body.dark-mode .border-gray-100,
      body.dark-mode .border-gray-200,
      body.dark-mode .border-gray-300 {
        border-color: #374151;
      }
      body.dark-mode nav {
        background-color: #1f2937;
        border-color: #374151;
      }
      body.dark-mode input,
      body.dark-mode textarea,
      body.dark-mode select {
        background-color: #374151;
        border-color: #4b5563;
        color: white;
      }
      body.dark-mode .card-hover:hover {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
      }

      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      }
      .sidebar-item {
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .sidebar-item:hover {
        background: rgba(99, 102, 241, 0.1);
        border-left: 4px solid #6366f1;
      }
      .sidebar-item.active {
        background: rgba(99, 102, 241, 0.15);
        border-left: 4px solid #6366f1;
        font-weight: 600;
      }
      .fade-in {
        animation: fadeIn 0.4s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s;
      }
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Navigation Bar -->
    <nav
      class="bg-white shadow-sm border-b border-gray-200 fixed w-full top-0 z-50 transition-colors duration-300"
    >
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <button
              id="sidebarToggle"
              class="lg:hidden text-gray-600 hover:text-gray-900"
            >
              <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="flex items-center space-x-3">
              <div class="bg-indigo-600 p-2 rounded-lg">
                <i class="fas fa-user-graduate text-white text-xl"></i>
              </div>
              <div>
                <h1 class="text-xl font-bold">UniPortal</h1>
                <p class="text-xs text-gray-500">Student Dashboard</p>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <button class="relative text-gray-600 hover:text-gray-900">
              <i class="fas fa-bell text-xl"></i
              ><span
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                >2</span
              >
            </button>
            <div class="flex items-center space-x-3 border-l pl-4">
              <!-- PROFILE SECTION -->
              <img
                id="profile-img"
                src="https://ui-avatars.com/api/?name=Alex+Doe&background=indigo&color=fff"
                class="w-10 h-10 rounded-full border-2 border-indigo-100"
                alt="Profile"
              />
              <div class="hidden md:block">
                <p class="text-sm font-semibold" id="profile-name">
                  Loading...
                </p>
                <p class="text-xs text-gray-500" id="profile-role">Student</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="flex pt-16 h-screen">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="fixed lg:static inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-40 mt-16 overflow-y-auto pb-20"
      >
        <div class="p-6 space-y-2">
          <!-- Note: onclick events modified to use window.switchView -->
          <div
            onclick="window.switchView('dashboard')"
            class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="dashboard"
          >
            <i class="fas fa-home text-indigo-600"></i><span>Dashboard</span>
          </div>
          <div
            onclick="window.switchView('courses')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="courses"
          >
            <i class="fas fa-book text-gray-400"></i><span>My Courses</span>
          </div>
          <div
            onclick="window.switchView('students')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="students"
          >
            <i class="fas fa-users text-gray-400"></i><span>Classmates</span>
          </div>
          <div
            onclick="window.switchView('assignments')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="assignments"
          >
            <i class="fas fa-tasks text-gray-400"></i><span>Assignments</span>
          </div>
          <div
            onclick="window.switchView('grades')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="grades"
          >
            <i class="fas fa-file-invoice text-gray-400"></i><span>Grades</span>
          </div>
          <div
            onclick="window.switchView('schedule')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="schedule"
          >
            <i class="fas fa-calendar-alt text-gray-400"></i
            ><span>Schedule</span>
          </div>
          <div
            onclick="window.switchView('attendance')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="attendance"
          >
            <i class="fas fa-user-check text-gray-400"></i
            ><span>Attendance</span>
          </div>
          <div
            onclick="window.switchView('feedback')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="feedback"
          >
            <i class="fas fa-comment-dots text-gray-400"></i
            ><span>Feedback</span>
          </div>
          <div
            onclick="window.switchView('analytics')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="analytics"
          >
            <i class="fas fa-chart-pie text-gray-400"></i><span>Analytics</span>
          </div>
          <div
            onclick="window.switchView('messages')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="messages"
          >
            <i class="fas fa-envelope text-gray-400"></i><span>Messages</span>
          </div>
          <div
            onclick="window.switchView('payments')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="payments"
          >
            <i class="fas fa-hand-holding-usd text-gray-400"></i>

            <span>Payments</span>
          </div>
          <div
            onclick="window.switchView('settings')"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg"
            data-target="settings"
          >
            <i class="fas fa-cog text-gray-400"></i><span>Settings</span>
          </div>

          <!-- ADDED LOGOUT BUTTON -->
          <div
            onclick="logout()"
            class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-500 hover:text-red-600"
          >
            <i class="fas fa-sign-out-alt w-5"></i><span>Logout</span>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main
        id="mainContent"
        class="flex-1 p-6 lg:ml-0 fade-in overflow-y-auto h-full pb-24"
      >
        <!-- Content injects here via JS -->
      </main>
    </div>

    <!-- GLOBAL MODALS CONTAINER -->
    <div id="modal-container"></div>

    <!-- MAIN LOGIC -->
    <script type="module">
      import { API } from "./api.js?v=6"; // Updated Version to force reload

      // ==========================================
      // AUTHENTICATION CHECK
      // ==========================================
      const token = localStorage.getItem("token");
      const userStr = localStorage.getItem("user");

      const currentUser = userStr
        ? JSON.parse(userStr)
        : { fullName: "Alex Doe", role: "Student" };

      // ==========================================
      // 1. GLOBAL HELPERS
      // ==========================================
      window.closeModal = function (id) {
        const m = document.getElementById(id);
        if (m) {
          m.classList.remove("show");
          setTimeout(() => m.remove(), 300);
        }
      };

      window.logout = function () {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.clear();
          window.location.href = "../../login.html";
        }
      };

      window.showModal = function (html) {
        const container = document.getElementById("modal-container");
        container.innerHTML = html;
        const modal = container.querySelector(".modal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);
      };

      // ==========================================
      // 2. DYNAMIC VIEW RENDERERS
      // ==========================================

      // --- DASHBOARD ---
      const renderDashboard = async () => {
        const data = await API.getDashboardData();

        const safeData = data || {
          gpa: 3.8,
          attendancePct: "95%",
          assignmentsCount: 4,
          coursesCount: 6,
          courses: [],
        };

        return `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
            <div class="flex items-center justify-between">
              <div><p class="text-sm text-gray-500 font-medium">Current GPA</p><h3 class="text-3xl font-bold mt-2">${safeData.gpa}</h3></div>
              <div class="bg-indigo-100 p-4 rounded-xl"><i class="fas fa-star text-indigo-600 text-2xl"></i></div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
             <div class="flex items-center justify-between">
              <div><p class="text-sm text-gray-500 font-medium">Attendance</p><h3 class="text-3xl font-bold mt-2">${safeData.attendancePct}</h3></div>
              <div class="bg-green-100 p-4 rounded-xl"><i class="fas fa-user-clock text-green-600 text-2xl"></i></div>
            </div>
          </div>
           <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
             <div class="flex items-center justify-between">
              <div><p class="text-sm text-gray-500 font-medium">Active Assignments</p><h3 class="text-3xl font-bold mt-2">${safeData.assignmentsCount}</h3></div>
              <div class="bg-orange-100 p-4 rounded-xl"><i class="fas fa-book text-orange-600 text-2xl"></i></div>
            </div>
          </div>
           <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
             <div class="flex items-center justify-between">
              <div><p class="text-sm text-gray-500 font-medium">Outstanding Fees</p><h3 class="text-3xl font-bold mt-2 text-red-600">$450.00</h3></div>
              <div class="bg-red-100 p-4 rounded-xl"><i class="fas fa-wallet text-red-600 text-2xl"></i></div>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
            <h2 class="text-xl font-bold text-gray-400">Welcome to your dashboard</h2>
            <p class="text-gray-500 mt-2">Select an item from the sidebar to get started.</p>
        </div>
      `;
      };

      const renderCourses = async () => {
        const courses = await API.getCourses();
        return `
        <div class="mb-8"><h2 class="text-3xl font-bold mb-2">My Curriculum</h2><p class="text-gray-500">Enrolled courses for the academic year.</p></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${courses
              .map(
                (c) => `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 card-hover border-t-4 border-${c.color || "indigo"}-500">
                <div class="flex items-center space-x-4 mb-4"><div class="bg-${c.color || "indigo"}-100 p-3 rounded-lg"><i class="fas ${c.img || "fa-book"} text-${c.color || "indigo"}-600 text-xl"></i></div><div><h3 class="font-bold">${c.name}</h3><p class="text-xs text-gray-500">${c.code}</p></div></div>
                <div class="mt-4"><div class="flex justify-between text-xs text-gray-500 mb-1"><span>Students</span><span>${c.students}</span></div><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-${c.color || "indigo"}-600 h-2 rounded-full" style="width: 65%"></div></div></div>
                <button class="mt-4 w-full py-2 bg-gray-50 hover:bg-gray-100 text-indigo-600 text-sm font-semibold rounded-lg transition">Enter Classroom</button>
            </div>`,
              )
              .join("")}
        </div>`;
      };

      const renderStudents = async () => {
        const students = await API.getClassmates();
        return `
        <div class="mb-6 flex justify-between items-center"><h2 class="text-2xl font-bold">Class Directory</h2></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
             <div class="p-4 border-b border-gray-100 bg-gray-50 font-semibold text-gray-700">All Classmates</div>
             <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-xs uppercase text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">ID</th><th class="p-4">Email</th></tr></thead>
                    <tbody class="divide-y divide-gray-100">
                    ${students
                      .map(
                        (s) => `
                        <tr class="hover:bg-gray-50">
                             <td class="p-4 flex items-center gap-3"><img src="https://ui-avatars.com/api/?name=${s.name}&background=random" class="w-8 h-8 rounded-full"><span class="font-bold text-gray-700">${s.name}</span></td>
                             <td class="p-4 text-sm text-gray-500">${s.id}</td>
                             <td class="p-4 text-sm text-gray-500">${s.email || "N/A"}</td>
                        </tr>`,
                      )
                      .join("")}
                    </tbody>
                </table>
             </div>
        </div>`;
      };

      const renderAssignments = async () => {
        const assignments = await API.getAssignments();
        return `
        <div class="mb-6 flex justify-between items-center"><div><h2 class="text-2xl font-bold text-gray-800">My Assignments</h2><p class="text-gray-500">Track deadlines.</p></div></div>
        <div class="space-y-4">
            ${assignments.length === 0 ? '<p class="text-gray-500">No active assignments.</p>' : ""}
            ${assignments
              .map(
                (a) => `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 flex flex-col md:flex-row items-center justify-between card-hover border-l-4 border-l-red-500">
                <div class="flex items-start space-x-4 mb-4 md:mb-0 w-full md:w-auto">
                    <div class="bg-red-50 p-3 rounded-lg"><i class="fas fa-exclamation-circle text-red-500 text-xl"></i></div>
                    <div><h3 class="font-bold text-gray-800">${a.title}</h3><p class="text-sm text-gray-500">${a.description || "No description"}</p><div class="mt-2 text-xs flex items-center space-x-3"><span class="text-red-600 font-semibold">Due: ${a.dueDate || "TBA"}</span></div></div>
                </div>
                <div class="flex items-center space-x-3 w-full md:w-auto justify-end">
                    <button class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-sm hover:bg-indigo-700 transition shadow btn-submit-assign">Submit Work</button>
                </div>
            </div>`,
              )
              .join("")}
        </div>`;
      };

      const renderGrades = async () => {
        const grades = await API.getGrades();
        return `
        <div class="mb-6"><h2 class="text-2xl font-bold text-gray-800">My Academic Report</h2></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Student Name</th><th class="px-6 py-3 text-center">Points</th><th class="px-6 py-3 text-center">Grade</th></tr></thead>
                        <tbody class="divide-y divide-gray-100">
                            ${grades
                              .map(
                                (g) => `
                            <tr class="bg-white hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium text-gray-900">${g.studentName || "Unknown"}</td>
                                <td class="px-6 py-4 text-center font-semibold">${g.points || 0}</td>
                                <td class="px-6 py-4 text-center"><span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">${g.grade || "F"}</span></td>
                            </tr>`,
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
        </div>`;
      };

      // --- SCHEDULE VIEW ---
      const renderSchedule = async () => {
        const scheduleData = await API.getSchedule();

        return `
        <div class="mb-8">
          <h2 class="text-3xl font-bold mb-2">Class Schedule</h2>
          <p class="text-gray-500">Weekly timetable and upcoming classes</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Upcoming Classes Card -->
          <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-800">This Week's Schedule</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50 text-gray-600 text-xs border-b">
                    <tr>
                      <th class="px-6 py-3 text-left">Day</th>
                      <th class="px-6 py-3 text-left">Time</th>
                      <th class="px-6 py-3 text-left">Course</th>
                      <th class="px-6 py-3 text-left">Room</th>
                      <th class="px-6 py-3 text-left">Instructor</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    ${
                      scheduleData && scheduleData.length > 0
                        ? scheduleData
                            .map(
                              (item) => `
                    <tr class="hover:bg-gray-50 transition">
                      <td class="px-6 py-4 font-medium text-gray-900">${item.day || "Monday"}</td>
                      <td class="px-6 py-4 text-gray-700">${item.time || "9:00 AM"}</td>
                      <td class="px-6 py-4">
                        <div class="font-medium">${item.course || "Computer Science"}</div>
                        <div class="text-xs text-gray-500">${item.code || "CS101"}</div>
                      </td>
                      <td class="px-6 py-4 text-gray-700">${item.room || "Room 302"}</td>
                      <td class="px-6 py-4">${item.instructor || "Dr. Smith"}</td>
                    </tr>
                    `,
                            )
                            .join("")
                        : `
                    <tr>
                      <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-calendar-alt text-3xl mb-3 opacity-20"></i>
                        <p>No schedule data available</p>
                      </td>
                    </tr>
                    `
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Calendar & Quick Actions -->
          <div class="space-y-6">
            <!-- Calendar Widget -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="p-4 border-b border-gray-100 bg-indigo-50">
                <div class="flex justify-between items-center">
                  <h3 class="font-bold text-indigo-900">Calendar</h3>
                  <div class="flex space-x-2">
                    <button class="p-1 hover:bg-indigo-100 rounded">
                      <i class="fas fa-chevron-left text-indigo-600"></i>
                    </button>
                    <button class="p-1 hover:bg-indigo-100 rounded">
                      <i class="fas fa-chevron-right text-indigo-600"></i>
                    </button>
                  </div>
                </div>
                <p class="text-sm text-indigo-600 mt-1">${new Date().toLocaleDateString("en-US", { month: "long", year: "numeric" })}</p>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-7 gap-1 text-center mb-3">
                  ${["S", "M", "T", "W", "T", "F", "S"]
                    .map(
                      (day) => `
                  <div class="text-xs font-bold text-gray-500 py-1">${day}</div>
                  `,
                    )
                    .join("")}
                </div>
                <div class="grid grid-cols-7 gap-1">
                  ${Array.from({ length: 31 }, (_, i) => {
                    const date = i + 1;
                    const isToday = date === new Date().getDate();
                    const hasEvent = [5, 12, 19, 26].includes(date);
                    return `
                    <div class="text-center">
                      <div class="text-sm p-1 rounded-full ${isToday ? "bg-indigo-600 text-white" : hasEvent ? "bg-red-100 text-red-700" : "text-gray-700 hover:bg-gray-100"}">
                        ${date}
                      </div>
                    </div>
                    `;
                  }).join("")}
                </div>
              </div>
            </div>
            
            <!-- Upcoming Deadlines -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="p-4 border-b border-gray-100">
                <h3 class="font-bold text-gray-800">Upcoming Deadlines</h3>
              </div>
              <div class="p-4 space-y-3">
                <div class="flex items-start space-x-3 p-3 bg-yellow-50 rounded-lg">
                  <div class="bg-yellow-100 p-2 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">Math Assignment</p>
                    <p class="text-xs text-gray-500">Due tomorrow, 11:59 PM</p>
                  </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-blue-50 rounded-lg">
                  <div class="bg-blue-100 p-2 rounded-lg">
                    <i class="fas fa-book text-blue-600"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">Physics Lab Report</p>
                    <p class="text-xs text-gray-500">Due in 3 days</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Class Details -->
        <div class="mt-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Class Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="p-4 bg-indigo-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-indigo-600 font-medium">Total Classes</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">12</h3>
                  </div>
                  <i class="fas fa-calendar-alt text-indigo-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-green-600 font-medium">Classes This Week</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">5</h3>
                  </div>
                  <i class="fas fa-chalkboard-teacher text-green-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-purple-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-purple-600 font-medium">Next Class</p>
                    <h3 class="text-lg font-bold text-gray-800 mt-1">Tomorrow</h3>
                  </div>
                  <i class="fas fa-clock text-purple-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-orange-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-orange-600 font-medium">Office Hours</p>
                    <h3 class="text-lg font-bold text-gray-800 mt-1">2:00 PM</h3>
                  </div>
                  <i class="fas fa-door-open text-orange-400 text-xl"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        `;
      };

      const renderAttendance = async () => {
        const attendance = await API.getAttendance(); // assuming this returns array of records

        return `
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white">
            <h3 class="font-bold text-gray-800 text-lg">Attendance History</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold border-b">
                    <tr>
                        <th class="px-6 py-4">Student ID</th>
                        <th class="px-6 py-4">Course ID</th>    <!-- ← New column added here -->
                        <th class="px-6 py-4">Date</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Time</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 bg-white">
                    ${attendance
                      .map(
                        (a) => `
                    <tr>
                        <td class="px-6 py-4 text-gray-500">${a.studentId || "—"}</td>
                        <td class="px-6 py-4 text-indigo-600 font-medium">${a.courseId || a.course || "—"}</td>    <!-- ← New column data -->
                        <td class="px-6 py-4 text-gray-800">${a.attendanceDate || "—"}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${
                              a.status === "Present" || a.status === "PRESENT"
                                ? "bg-green-100 text-green-700"
                                : a.status === "Late" || a.status === "LATE"
                                  ? "bg-yellow-100 text-yellow-700"
                                  : "bg-red-100 text-red-700"
                            }">
                                ${a.status || "—"}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-gray-500">${a.checkInTime || "—"}</td>
                    </tr>`,
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    </div>`;
      };

      // --- FEEDBACK VIEW ---
      const renderFeedback = async () => {
        const feedbackData = await API.getFeedback();

        return `
        <div class="mb-8">
          <h2 class="text-3xl font-bold mb-2">Course Feedback</h2>
          <p class="text-gray-500">Provide feedback on your courses and instructors</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Feedback Form -->
          <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-800">Submit Feedback</h3>
              </div>
              <div class="p-6">
                <form id="feedbackForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Course</label>
                    <select class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                      <option value="">Choose a course...</option>
                      <option value="cs101">CS101 - Introduction to Programming</option>
                      <option value="math201">MATH201 - Calculus II</option>
                      <option value="phy102">PHY102 - Physics Laboratory</option>
                      <option value="eng101">ENG101 - English Composition</option>
                    </select>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                    <div class="flex space-x-2">
                      ${[1, 2, 3, 4, 5]
                        .map(
                          (star) => `
                      <button type="button" class="rating-star p-2 text-2xl text-gray-300 hover:text-yellow-400" data-value="${star}">
                        <i class="far fa-star"></i>
                      </button>
                      `,
                        )
                        .join("")}
                    </div>
                    <input type="hidden" id="ratingValue" name="rating" value="0">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Feedback Type</label>
                    <div class="flex flex-wrap gap-2">
                      ${[
                        "Course Content",
                        "Teaching Method",
                        "Assignments",
                        "Resources",
                        "Communication",
                        "Other",
                      ]
                        .map(
                          (type) => `
                      <label class="inline-flex items-center">
                        <input type="radio" name="feedbackType" value="${type.toLowerCase()}" class="hidden peer">
                        <span class="px-3 py-1 border border-gray-300 rounded-lg peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 cursor-pointer text-sm">
                          ${type}
                        </span>
                      </label>
                      `,
                        )
                        .join("")}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Feedback</label>
                    <textarea 
                      rows="4" 
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                      placeholder="Please provide detailed feedback about the course..."
                    ></textarea>
                  </div>
                  
                  <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                      <input type="checkbox" id="anonymous" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                      <label for="anonymous" class="ml-2 text-sm text-gray-600">Submit anonymously</label>
                    </div>
                  </div>
                  
                  <div class="pt-4">
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition">
                      Submit Feedback
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Feedback History & Guidelines -->
          <div class="space-y-6">
            <!-- Feedback History -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="p-4 border-b border-gray-100">
                <h3 class="font-bold text-gray-800">Recent Feedback</h3>
              </div>
              <div class="p-4 space-y-4 max-h-96 overflow-y-auto">
                ${
                  feedbackData && feedbackData.length > 0
                    ? feedbackData
                        .map(
                          (feedback) => `
                <div class="p-3 border border-gray-100 rounded-lg">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <span class="font-medium text-sm">${feedback.course || "Unknown Course"}</span>
                      <div class="flex items-center mt-1">
                        ${Array.from({ length: 5 })
                          .map(
                            (_, i) => `
                        <i class="fas fa-star ${i < (feedback.rating || 0) ? "text-yellow-400" : "text-gray-300"} text-xs"></i>
                        `,
                          )
                          .join("")}
                      </div>
                    </div>
                    <span class="text-xs text-gray-500">${feedback.date || "Recently"}</span>
                  </div>
                  <p class="text-sm text-gray-600 truncate">${feedback.comment || "No comment provided"}</p>
                  <div class="mt-2">
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${feedback.status === "Reviewed" ? "bg-green-100 text-green-700" : "bg-yellow-100 text-yellow-700"}">
                      ${feedback.status || "Pending"}
                    </span>
                  </div>
                </div>
                `,
                        )
                        .join("")
                    : `
                <div class="text-center py-8 text-gray-500">
                  <i class="fas fa-comment-alt text-3xl mb-3 opacity-20"></i>
                  <p>No feedback submitted yet</p>
                </div>
                `
                }
              </div>
            </div>
            
            <!-- Feedback Guidelines -->
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-5">
              <div class="flex items-center mb-3">
                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                  <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <h4 class="font-bold text-blue-900">Feedback Guidelines</h4>
              </div>
              <ul class="space-y-2 text-sm text-blue-800">
                <li class="flex items-start">
                  <i class="fas fa-check-circle text-blue-500 mt-0.5 mr-2 text-xs"></i>
                  <span>Be specific and constructive</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-check-circle text-blue-500 mt-0.5 mr-2 text-xs"></i>
                  <span>Focus on the course, not the instructor personally</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-check-circle text-blue-500 mt-0.5 mr-2 text-xs"></i>
                  <span>Suggest improvements when possible</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-check-circle text-blue-500 mt-0.5 mr-2 text-xs"></i>
                  <span>All feedback is reviewed by the department</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Feedback Statistics -->
        <div class="mt-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Feedback Statistics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="p-4 bg-green-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-green-600 font-medium">Submitted</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">12</h3>
                  </div>
                  <i class="fas fa-paper-plane text-green-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-blue-600 font-medium">Average Rating</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">4.2</h3>
                  </div>
                  <i class="fas fa-star text-blue-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-purple-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-purple-600 font-medium">Reviewed</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">8</h3>
                  </div>
                  <i class="fas fa-check-circle text-purple-400 text-xl"></i>
                </div>
              </div>
              <div class="p-4 bg-orange-50 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-orange-600 font-medium">Response Rate</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">75%</h3>
                  </div>
                  <i class="fas fa-comment-alt text-orange-400 text-xl"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        `;
      };

      const renderMessages = async () => {
        return `
        <div class="h-[calc(100vh-140px)] flex bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="w-1/3 border-r border-gray-200 flex flex-col bg-gray-50">
                <div class="p-4 border-b border-gray-200 bg-white"><input type="text" placeholder="Search..." class="w-full bg-gray-100 border-none rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500"></div>
                <div class="overflow-y-auto flex-1">
                    <div class="p-4 border-b border-gray-100 hover:bg-white cursor-pointer bg-white border-l-4 border-l-indigo-600"><div class="flex justify-between mb-1"><span class="font-bold text-gray-800">Dr. Sarah Smith</span><span class="text-xs text-gray-500">10:36 AM</span></div><p class="text-sm text-gray-500 truncate">Great. Let me know if you need help.</p></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col bg-white">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50"><div class="flex items-center space-x-3"><div class="relative"><img src="https://ui-avatars.com/api/?name=Sarah+Smith&background=random" class="w-10 h-10 rounded-full"><span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span></div><div><h3 class="font-bold text-gray-800">Dr. Sarah Smith</h3><p class="text-xs text-green-600">Online</p></div></div></div>
                <div id="chatBox" class="flex-1 p-6 overflow-y-auto space-y-4 bg-gray-50/50"></div>
                <div class="p-4 border-t border-gray-200 bg-white">
                    <div class="flex items-center gap-2"><button class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-paperclip"></i></button><input type="text" id="chatInput" placeholder="Write a message..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"><button id="sendBtn" class="bg-indigo-600 text-white w-10 h-10 rounded-full hover:bg-indigo-700 transition flex items-center justify-center shadow"><i class="fas fa-paper-plane"></i></button></div>
                </div>
            </div>
        </div>`;
      };

      // --- ANALYTICS VIEW ---
      const renderAnalytics = async () => {
        const analyticsData = await API.getAnalytics();

        return `
        <div class="mb-8">
          <h2 class="text-3xl font-bold mb-2">Performance Analytics</h2>
          <p class="text-gray-500">Track your academic progress and performance metrics</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
          <!-- Performance Summary Cards -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-sm text-gray-500 font-medium">Current GPA</p>
                <h3 class="text-3xl font-bold mt-2">3.85</h3>
              </div>
              <div class="bg-indigo-100 p-4 rounded-xl">
                <i class="fas fa-chart-line text-indigo-600 text-2xl"></i>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <span class="text-green-600 font-medium">↑ 0.15</span> from last semester
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-sm text-gray-500 font-medium">Attendance Rate</p>
                <h3 class="text-3xl font-bold mt-2">94%</h3>
              </div>
              <div class="bg-green-100 p-4 rounded-xl">
                <i class="fas fa-user-check text-green-600 text-2xl"></i>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <span class="text-green-600 font-medium">↑ 2%</span> improvement
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-sm text-gray-500 font-medium">Assignment Completion</p>
                <h3 class="text-3xl font-bold mt-2">88%</h3>
              </div>
              <div class="bg-orange-100 p-4 rounded-xl">
                <i class="fas fa-tasks text-orange-600 text-2xl"></i>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <span class="text-red-600 font-medium">↓ 5%</span> needs improvement
            </div>
          </div>
        </div>
        
        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <!-- GPA Trend Chart -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-4">GPA Trend</h3>
            <div class="h-64">
              <canvas id="gpaChart"></canvas>
            </div>
          </div>
          
          <!-- Course Performance Chart -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-4">Course Performance</h3>
            <div class="h-64">
              <canvas id="courseChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Detailed Analytics -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-5 border-b border-gray-100 bg-gray-50">
            <h3 class="font-bold text-gray-800">Detailed Performance Metrics</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-600 text-xs border-b">
                <tr>
                  <th class="px-6 py-3 text-left">Course</th>
                  <th class="px-6 py-3 text-left">Grade</th>
                  <th class="px-6 py-3 text-left">Attendance</th>
                  <th class="px-6 py-3 text-left">Assignments</th>
                  <th class="px-6 py-3 text-left">Exams</th>
                  <th class="px-6 py-3 text-left">Performance</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 font-medium text-gray-900">CS101 - Programming</td>
                  <td class="px-6 py-4">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">A</span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 96%"></div>
                      </div>
                      <span class="text-sm">96%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 92%"></div>
                      </div>
                      <span class="text-sm">92%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 94%"></div>
                      </div>
                      <span class="text-sm">94%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="text-green-600 font-medium">Excellent</span>
                  </td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 font-medium text-gray-900">MATH201 - Calculus</td>
                  <td class="px-6 py-4">
                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">B+</span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 88%"></div>
                      </div>
                      <span class="text-sm">88%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 85%"></div>
                      </div>
                      <span class="text-sm">85%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 82%"></div>
                      </div>
                      <span class="text-sm">82%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="text-blue-600 font-medium">Good</span>
                  </td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 font-medium text-gray-900">PHY102 - Physics Lab</td>
                  <td class="px-6 py-4">
                    <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">C+</span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 75%"></div>
                      </div>
                      <span class="text-sm">75%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 70%"></div>
                      </div>
                      <span class="text-sm">70%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 68%"></div>
                      </div>
                      <span class="text-sm">68%</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="text-yellow-600 font-medium">Needs Improvement</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Recommendations Section -->
        <div class="mt-8">
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center mb-4">
              <div class="bg-white/20 p-3 rounded-lg mr-4">
                <i class="fas fa-lightbulb text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold">Personalized Recommendations</h3>
                <p class="text-indigo-100">Based on your analytics data</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="bg-white/10 p-4 rounded-lg">
                <div class="flex items-center mb-2">
                  <i class="fas fa-book-reader mr-2"></i>
                  <span class="font-bold">Study Strategy</span>
                </div>
                <p class="text-sm">Increase Physics study time by 2 hours weekly</p>
              </div>
              <div class="bg-white/10 p-4 rounded-lg">
                <div class="flex items-center mb-2">
                  <i class="fas fa-user-clock mr-2"></i>
                  <span class="font-bold">Attendance Goal</span>
                </div>
                <p class="text-sm">Aim for 95% attendance in all courses</p>
              </div>
              <div class="bg-white/10 p-4 rounded-lg">
                <div class="flex items-center mb-2">
                  <i class="fas fa-tasks mr-2"></i>
                  <span class="font-bold">Assignment Focus</span>
                </div>
                <p class="text-sm">Submit assignments 2 days before deadline</p>
              </div>
            </div>
          </div>
        </div>
        `;
      };

      // --- WEBSOCKET SETUP ---
      let stompClient = null;

      function connectWebSocket() {
        const socket = new SockJS("http://206.189.94.76:8080/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function (frame) {
          console.log("Connected to Payment WebSocket");
          stompClient.subscribe("/topic/payments", function (paymentUpdate) {
            const payment = JSON.parse(paymentUpdate.body);
            handlePaymentUpdate(payment);
          });
        });
      }

      function handlePaymentUpdate(payment) {
        const modal = document.getElementById("khqrModal");
        if (
          modal &&
          modal.dataset.paymentId == payment.id &&
          payment.status === "PAID"
        ) {
          showSuccessModal();
        }
        const currentView = document.querySelector(".sidebar-item.active")
          .dataset.target;
        if (currentView === "payments") {
          window.switchView("payments");
        }
      }

      connectWebSocket();

      // --- PAYMENT RENDERER ---
      const renderPayments = async () => {
        // 1. Fetch History
        const history = await API.getUserPayments();
        const myPayments = history || [];
        const unpaid = myPayments.filter((p) => p.status === "PENDING");
        const pendingBalance = unpaid.reduce(
          (sum, p) => sum + (p.amount || 0),
          0,
        );

        // 2. Fetch Tuition Data
        let tuitionData = { totalAmount: 0, courseCount: 0, breakdown: [] };

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            "http://206.189.94.76:8080/payments/my-invoice",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            },
          );

          if (response.ok) {
            tuitionData = await response.json();
            if (!tuitionData.breakdown) {
              tuitionData.breakdown = [];
            }
          }
        } catch (e) {
          console.error("Tuition Invoice Error", e);
        }

        // --- PAYMENT STATUS LOGIC ---
        const totalAmount = tuitionData.totalAmount || 0;
        const hasCourses = (tuitionData.courseCount || 0) > 0;

        // Is Payable? (Must be > 0)
        const isPayable = totalAmount > 0;

        // Is Fully Paid? (Has courses but amount is 0)
        const isFullyPaid = hasCourses && totalAmount === 0;

        // --- NEW LOGIC: Check for Existing Pending Transaction ---
        // Look for a transaction that is PENDING and matches the exact Tuition Amount
        const existingPendingTx = myPayments.find(
          (p) =>
            p.status === "PENDING" && Math.abs(p.amount - totalAmount) < 0.01, // Safety check for float comparison
        );

        // Determine Button Style & Text
        let btnClass = "bg-gray-200 text-gray-400 cursor-not-allowed";
        let btnText = "No Balance";
        let btnIcon = "fa-ban";
        let btnAction = ""; // We will store the onclick function here

        if (isFullyPaid) {
          // CASE 1: PAID
          btnClass = "bg-green-600 text-white cursor-default opacity-90";
          btnText = "Paid";
          btnIcon = "fa-check-double";
          btnAction = ""; // No action
        } else if (existingPendingTx) {
          // CASE 2: PENDING (Prevent new generation, show existing)
          btnClass =
            "bg-orange-500 hover:bg-orange-600 text-white shadow-lg transform active:scale-95 cursor-pointer";
          btnText = "View Pending QR";
          btnIcon = "fa-eye";
          // Open the existing QR code instead of making a new one
          btnAction = `window.viewExistingQR('${existingPendingTx.qrCode}', '${existingPendingTx.amount}', ${existingPendingTx.id})`;
        } else if (isPayable) {
          // CASE 3: PAYABLE (Generate new)
          btnClass =
            "bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform active:scale-95 cursor-pointer";
          btnText = "Pay Tuition";
          btnIcon = "fa-qrcode";
          btnAction = `window.initCustomKHQR(${totalAmount})`;
        }

        return `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        
        <!-- TUITION INVOICE CARD -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full">
            <div class="p-5 border-b border-gray-100 bg-indigo-50">
                <h3 class="font-bold text-indigo-900">Tuition Invoice</h3>
                <p class="text-xs text-indigo-600">You are enrolled in ${tuitionData.courseCount || 0} courses</p>
            </div>
            
            <!-- List of Courses -->
            <div class="p-5 flex-1 overflow-y-auto max-h-64">
                <div class="space-y-3">
                    ${
                      tuitionData.breakdown.length === 0
                        ? `<div class="flex flex-col items-center justify-center h-full py-4 text-gray-400">
                             <i class="fas fa-clipboard-check text-3xl mb-2 opacity-20"></i>
                             <p class="text-sm">No pending tuition fees.</p>
                           </div>`
                        : ""
                    }
                    ${tuitionData.breakdown
                      .map(
                        (item) => `
                        <div class="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                            <div>
                                <span class="text-gray-700 font-medium block">${item.courseName || "Course Fee"}</span>
                                <span class="text-gray-400 text-xs">${item.courseCode || ""}</span>
                            </div>
                            <span class="font-bold text-gray-800">៛${(item.price || 0).toFixed(2)}</span>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            </div>

            <!-- Footer: Total & Action -->
            <div class="p-5 border-t border-gray-100 bg-gray-50">
                
                <!-- Success Message if Paid -->
                ${
                  isFullyPaid
                    ? `
                <div class="mb-4 bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-center gap-3 animate-pulse">
                    <i class="fas fa-check-circle text-xl"></i>
                    <div>
                        <p class="font-bold text-sm">Tuition Fully Paid</p>
                        <p class="text-[10px] uppercase font-bold tracking-wide">No Further Actions</p>
                    </div>
                </div>`
                    : ""
                }

                <!-- Warning Message if Pending -->
                ${
                  existingPendingTx && !isFullyPaid
                    ? `
                <div class="mb-4 bg-orange-50 border border-orange-100 text-orange-700 px-4 py-2 rounded-lg flex items-center gap-3">
                    <i class="fas fa-exclamation-circle"></i>
                    <p class="text-xs">Payment pending. Scan existing QR.</p>
                </div>`
                    : ""
                }

                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold text-gray-700">Total Due</span>
                    <span class="font-bold text-3xl ${isPayable ? "text-indigo-600" : isFullyPaid ? "text-green-600" : "text-gray-400"}">
                        ៛${totalAmount.toFixed(2)}
                    </span>
                </div>

                <button 
                    onclick="${btnAction}" 
                    ${!isPayable && !existingPendingTx && !isFullyPaid ? "disabled" : ""}
                    class="w-full font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 ${btnClass}">
                    <i class="fas ${btnIcon}"></i> ${btnText}
                </button>
            </div>
        </div>

        <!-- RIGHT COLUMN: Custom Pay & History (Unchanged) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Outstanding Summary -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-red-500">
                    <p class="text-gray-500 text-sm font-medium">Pending Payments</p>
                    <div class="flex items-end justify-between mt-2">
                        <h2 class="text-4xl font-bold text-gray-800">៛${pendingBalance.toFixed(2)}</h2>
                        <span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-lg font-bold">Unpaid</span>
                    </div>
                </div>

                <!-- Custom Amount -->
                <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 rounded-xl shadow-lg p-6 text-white flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                    <h2 class="text-lg font-bold mb-1 relative z-10">Other Fees?</h2>
                    <p class="text-indigo-200 text-xs mb-4 relative z-10">Library fines, gym fees, etc.</p>
                    <div class="flex gap-2 relative z-10">
                        <div class="relative w-full">
                            <span class="absolute left-3 top-2 text-indigo-300">៛</span>
                            <input type="number" id="customAmount" placeholder="0.00" class="w-full bg-white/10 border border-white/20 text-white pl-6 pr-3 py-2 rounded-lg focus:outline-none focus:bg-white/20 transition">
                        </div>
                        <button onclick="window.initCustomKHQR()" class="bg-white text-indigo-900 font-bold px-4 py-2 rounded-lg hover:bg-indigo-50 transition shadow">
                            Pay
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4">Transaction History</h3>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    ${myPayments.length === 0 ? '<p class="p-8 text-center text-gray-400">No payment history available.</p>' : ""}
                    ${myPayments
                      .map(
                        (p) => `
                    <div class="p-4 border-b border-gray-100 last:border-0 flex flex-col sm:flex-row items-center justify-between gap-4 hover:bg-gray-50 transition group">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center ${p.status === "PAID" ? "bg-green-100 text-green-600" : "bg-orange-100 text-orange-600"}">
                                <i class="fas ${p.status === "PAID" ? "fa-check" : "fa-clock"} text-lg"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">${p.description || "General Payment"}</p>
                                <div class="flex items-center gap-2 text-xs text-gray-500">
                                    <span><i class="far fa-calendar-alt"></i> ${new Date(p.createdAt).toLocaleDateString()}</span>
                                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${p.status === "PAID" ? "bg-green-100 text-green-700" : "bg-orange-100 text-orange-700"}">${p.status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 w-full sm:w-auto justify-end">
                            <span class="font-bold text-gray-800 text-lg">៛${(p.amount || 0).toFixed(2)}</span>
                            ${
                              p.status === "PENDING"
                                ? `<button onclick="window.viewExistingQR('${p.qrCode}', '${p.amount}', ${p.id})" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg text-xs font-bold transition">
                                    QR Code
                                </button>`
                                : ""
                            }
                        </div>
                    </div>
                    `,
                      )
                      .join("")}
                </div>
            </div>
        </div>
    </div>
    `;
      };
      // --- CONSOLIDATED INIT KHQR FUNCTION ---
      window.initCustomKHQR = async function (specificAmount = null) {
        let amount;
        let desc = "Tuition Fee Payment";

        // 1. Determine Amount
        if (specificAmount) {
          amount = specificAmount;
        } else {
          const amountInput = document.getElementById("customAmount");
          amount = amountInput ? parseFloat(amountInput.value) : 0;
          desc = "Custom Payment";
        }

        if (!amount || amount <= 0) {
          alert("Please enter a valid amount");
          return;
        }

        // --- NEW: DUPLICATE CHECK ---
        // Before creating, check if we already have a PENDING payment for this amount
        try {
          const history = await API.getUserPayments();
          const existingPayment = history.find(
            (p) => p.status === "PENDING" && Math.abs(p.amount - amount) < 0.01, // Compare amounts safely
          );

          if (existingPayment) {
            // STOP! Don't create new. Open the existing one.
            console.log("Pending payment found. Opening existing QR.");
            window.viewExistingQR(
              existingPayment.qrCode,
              existingPayment.amount,
              existingPayment.id,
            );

            // Show a small notification toast (optional)
            const container = document.getElementById("modal-container");
            const toast = document.createElement("div");
            toast.className =
              "fixed top-5 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-6 py-3 rounded-full shadow-xl z-[100] fade-in flex items-center gap-2";
            toast.innerHTML =
              '<i class="fas fa-info-circle"></i> <span>Opened existing pending bill</span>';
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);

            return; // <--- EXIT FUNCTION HERE
          }
        } catch (e) {
          console.error("Could not check payment history", e);
        }
        // ---------------------------

        showModal(
          `<div class="modal show"><div class="bg-white p-8 rounded-xl text-center"><i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i><p class="font-semibold text-gray-700">Connecting to Bakong...</p></div></div>`,
        );

        try {
          // Proceed to create ONLY if no duplicate was found
          const response = await API.createPayment(amount, desc);

          if (response && response.success) {
            const qrString =
              response.qr || response.payment?.qrCode || response.qrCode;
            const paymentId =
              response.paymentId || response.payment?.id || response.id;
            const md5 =
              response.md5 || response.payment?.md5Hash || response.md5Hash;

            if (qrString) {
              const qrImage = await API.fetchQRImage(qrString);
              displayQRModal(qrImage, amount, paymentId, md5);
            } else {
              closeModal("modal-container");
              alert("Error: QR Data missing.");
            }
          } else {
            closeModal("modal-container");
            alert("Failed: " + (response.error || "Unknown error"));
          }
        } catch (e) {
          console.error(e);
          closeModal("modal-container");
        }
      };
      // --- CONSOLIDATED INIT KHQR FUNCTION ---
      // This handles both the Tuition Button (specificAmount) and the Custom Input (null)
      window.initCustomKHQR = async function (specificAmount = null) {
        let amount;
        let desc = "Tuition Fee Payment";

        if (specificAmount) {
          amount = specificAmount;
        } else {
          const amountInput = document.getElementById("customAmount");
          amount = amountInput ? amountInput.value : 0;
          desc = "Custom Payment";
        }

        if (!amount || amount <= 0) {
          alert("Please enter a valid amount");
          return;
        }

        showModal(
          `<div class="modal show"><div class="bg-white p-8 rounded-xl text-center"><i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i><p class="font-semibold text-gray-700">Connecting to Bakong...</p></div></div>`,
        );

        try {
          const response = await API.createPayment(amount, desc);

          if (response && response.success) {
            const qrString =
              response.qr ||
              (response.payment && response.payment.qrCode) ||
              response.qrCode;
            const paymentId =
              response.paymentId ||
              (response.payment && response.payment.id) ||
              response.id;
            const md5 =
              response.md5 ||
              (response.payment && response.payment.md5Hash) ||
              response.md5Hash;

            if (qrString) {
              const qrImage = await API.fetchQRImage(qrString);
              displayQRModal(qrImage, amount, paymentId, md5);
            } else {
              closeModal("modal-container");
              alert("Error: QR Data missing.");
            }
          } else {
            closeModal("modal-container");
            alert("Failed: " + (response.error || "Unknown error"));
          }
        } catch (e) {
          console.error(e);
          closeModal("modal-container");
        }
      };

      // ✅ View Existing QR logic
      window.viewExistingQR = async function (qrString, amount, id) {
        const qrImage = await API.fetchQRImage(qrString);
        displayQRModal(qrImage, amount, id, null);
      };

      let pollingInterval = null;

      function displayQRModal(imgSrc, amount, paymentId, md5) {
        const html = `
          <div id="khqrModal" class="modal" data-payment-id="${paymentId}">
             <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-bounce-in relative">
                <button onclick="closeModal('khqrModal')" class="absolute top-4 right-4 text-white hover:text-gray-200 z-10"><i class="fas fa-times text-xl"></i></button>
                
                <div class="bg-red-600 p-6 pt-10 text-center text-white relative">
                     <img src="https://bakong.nbc.gov.kh/images/khqr-logo.png" class="h-12 mx-auto brightness-0 invert" alt="Bakong">
                     <p class="mt-2 opacity-90">Scan to pay with any banking app</p>
                </div>
                
                <div class="p-6 text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-1">៛${Number(amount).toFixed(2)}</h2>
                    <p class="text-xs text-gray-400 mb-6">Payment ID: ${paymentId}</p>

                    <div class="mx-auto w-64 h-64 border-2 border-red-600 rounded-lg p-2 mb-6 relative flex items-center justify-center">
                        <img src="${imgSrc}" class="w-full h-full object-contain">
                    </div>

                    <div class="flex items-center justify-center gap-2 mb-4">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <p class="text-sm text-gray-600 font-medium">Checking payment status...</p>
                    </div>
                    
                    <button onclick="checkStatusManual(${paymentId})" class="text-xs text-indigo-600 hover:underline">
                        Check Now (Force)
                    </button>
                </div>
             </div>
          </div>`;

        showModal(html);

        // ✅ START POLLING: Check every 3 seconds
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
          const res = await API.checkTransactionStatus(paymentId);
          if (res && res.success && res.status === "PAID") {
            clearInterval(pollingInterval);
            showSuccessModal();
          }
        }, 3000);
      }

      // Modify closeModal to stop polling
      const originalCloseModal = window.closeModal;
      window.closeModal = function (id) {
        if (id === "khqrModal" && pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
        originalCloseModal(id);
      };

      // Manual Check
      window.checkStatusManual = async function (id) {
        const res = await API.checkTransactionStatus(id);
        if (res && res.success && res.status === "PAID") {
          showSuccessModal();
        } else {
          alert("Payment not received yet. Please scan and pay first.");
        }
      };

      window.showSuccessModal = function () {
        const modalContent = document.querySelector("#khqrModal > div");
        if (modalContent) {
          modalContent.innerHTML = `
        <div class="p-8 text-center flex flex-col items-center justify-center h-full bg-white">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                <i class="fas fa-check text-5xl text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful!</h3>
            <p class="text-gray-500 mb-8">Thank you for your payment.</p>
            <button onclick="closeModal('khqrModal'); window.switchView('payments')" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform hover:-translate-y-1">
                Close & Refresh
            </button>
        </div>`;
        }
      };

      const settingsView = `
        <div class="max-w-3xl">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Settings</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                <h3 class="text-lg font-bold mb-4 border-b pb-2 text-gray-800">Appearance</h3>
                <div class="flex items-center justify-between py-4"><div><p class="font-medium text-gray-800">Dark Mode</p><p class="text-sm text-gray-500">Switch between light and dark themes</p></div><button id="themeToggle" class="bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"><span aria-hidden="true" class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span></button></div>
            </div>
        </div>`;

      // ==========================================
      // 3. LOGIC & EVENTS
      // ==========================================

      function attachAssignmentEvents() {
        const btns = document.querySelectorAll(".btn-submit-assign");
        btns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const modalHtml = `
                    <div id="submitModal" class="modal">
                        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4">
                            <h3 class="text-xl font-bold mb-4">Submit Assignment</h3>
                            <form id="submissionForm" class="space-y-4">
                                <input required type="text" class="w-full border rounded p-2" placeholder="Submission Title">
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal('submitModal')" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded">Submit</button>
                                </div>
                            </form>
                        </div>
                    </div>`;
            showModal(modalHtml);
            document
              .getElementById("submissionForm")
              .addEventListener("submit", (e) => {
                e.preventDefault();
                alert("Assignment Submitted!");
                closeModal("submitModal");
              });
          });
        });
      }

      async function attachMessageEvents() {
        const input = document.getElementById("chatInput");
        const btn = document.getElementById("sendBtn");
        const box = document.getElementById("chatBox");

        // LOAD MESSAGES
        const messages = await API.getMessages();

        if (box) {
          box.innerHTML = messages
            .map(
              (m) => `
                <div class="flex ${
                  m.type === "sent" ? "justify-end" : "justify-start"
                }">
                    <div class="${
                      m.type === "sent"
                        ? "bg-indigo-600 text-white"
                        : "bg-white border text-gray-800"
                    } p-3 rounded-2xl shadow-sm max-w-xs text-sm">
                        <p>${
                          m.text
                        }</p><p class="text-[10px] mt-1 text-right">${
                          m.time
                        }</p>
                    </div>
                </div>`,
            )
            .join("");
          box.scrollTop = box.scrollHeight;
        }

        const send = () => {
          if (!input.value.trim()) return;
          box.innerHTML += `<div class="flex justify-end fade-in"><div class="bg-indigo-600 text-white p-3 rounded-2xl shadow-sm max-w-xs text-sm"><p>${input.value}</p></div></div>`;
          box.scrollTop = box.scrollHeight;
          input.value = "";
        };

        if (btn && input) {
          btn.addEventListener("click", send);
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") send();
          });
        }
      }

      function attachSettingsEvents() {
        const btn = document.getElementById("themeToggle");
        if (btn) {
          btn.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            // Visual toggle logic...
          });
        }
      }

      // --- Feedback Form Logic ---
      function attachFeedbackEvents() {
        // Star rating functionality
        const starButtons = document.querySelectorAll(".rating-star");
        starButtons.forEach((star) => {
          star.addEventListener("click", function () {
            const value = parseInt(this.getAttribute("data-value"));
            const hiddenInput = document.getElementById("ratingValue");
            hiddenInput.value = value;

            // Update star display
            starButtons.forEach((s, index) => {
              const icon = s.querySelector("i");
              if (index < value) {
                icon.classList.remove("far", "fa-star");
                icon.classList.add("fas", "fa-star", "text-yellow-400");
              } else {
                icon.classList.remove("fas", "fa-star", "text-yellow-400");
                icon.classList.add("far", "fa-star");
              }
            });
          });
        });

        // Feedback form submission
        const feedbackForm = document.getElementById("feedbackForm");
        if (feedbackForm) {
          feedbackForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const rating = document.getElementById("ratingValue").value;
            const feedbackType = formData.get("feedbackType");
            const comment = this.querySelector("textarea").value;
            const anonymous = this.querySelector("#anonymous").checked;

            if (rating === "0") {
              alert("Please select a rating");
              return;
            }

            if (!feedbackType) {
              alert("Please select a feedback type");
              return;
            }

            try {
              // Submit feedback via API
              const response = await API.submitFeedback({
                rating: parseInt(rating),
                type: feedbackType,
                comment: comment,
                anonymous: anonymous,
                timestamp: new Date().toISOString(),
              });

              if (response.success) {
                alert("Thank you for your feedback!");
                this.reset();

                // Reset stars
                starButtons.forEach((star) => {
                  const icon = star.querySelector("i");
                  icon.classList.remove("fas", "fa-star", "text-yellow-400");
                  icon.classList.add("far", "fa-star");
                });
                document.getElementById("ratingValue").value = "0";

                // Refresh feedback view
                window.switchView("feedback");
              } else {
                alert(
                  "Failed to submit feedback: " +
                    (response.error || "Unknown error"),
                );
              }
            } catch (error) {
              console.error("Feedback submission error:", error);
              alert("An error occurred while submitting feedback");
            }
          });
        }
      }

      // --- Analytics Chart Initialization ---
      function initAnalyticsCharts() {
        // GPA Trend Chart
        const gpaCtx = document.getElementById("gpaChart");
        if (gpaCtx) {
          new Chart(gpaCtx.getContext("2d"), {
            type: "line",
            data: {
              labels: ["Sem 1", "Sem 2", "Sem 3", "Sem 4", "Sem 5", "Sem 6"],
              datasets: [
                {
                  label: "GPA",
                  data: [3.2, 3.5, 3.7, 3.8, 3.85, 3.9],
                  borderColor: "#6366f1",
                  backgroundColor: "rgba(99, 102, 241, 0.1)",
                  tension: 0.3,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: false,
                  min: 3.0,
                  max: 4.0,
                },
              },
            },
          });
        }

        // Course Performance Chart
        const courseCtx = document.getElementById("courseChart");
        if (courseCtx) {
          new Chart(courseCtx.getContext("2d"), {
            type: "bar",
            data: {
              labels: ["CS101", "MATH201", "PHY102", "ENG101", "HIST103"],
              datasets: [
                {
                  label: "Grade Points",
                  data: [94, 82, 68, 88, 91],
                  backgroundColor: [
                    "#10b981",
                    "#3b82f6",
                    "#f59e0b",
                    "#8b5cf6",
                    "#ec4899",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
              },
            },
          });
        }
      }

      // ==========================================
      // 4. ROUTER
      // ==========================================

      window.switchView = async function (viewName) {
        const main = document.getElementById("mainContent");
        // Show Loading Spinner
        main.innerHTML = `<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;

        // Sidebar Active State Logic...
        document.querySelectorAll(".sidebar-item").forEach((item) => {
          item.classList.remove("active");
          item
            .querySelector("i")
            .classList.replace("text-indigo-600", "text-gray-400");
        });
        const active = document.querySelector(`[data-target="${viewName}"]`);
        if (active) {
          active.classList.add("active");
          active
            .querySelector("i")
            .classList.replace("text-gray-400", "text-indigo-600");
        }

        // --- NEW ERROR HANDLING LOGIC ---
        try {
          let html = "";
          switch (viewName) {
            case "dashboard":
              html = await renderDashboard();
              break;
            case "courses":
              html = await renderCourses();
              break;
            case "students":
              html = await renderStudents();
              break;
            case "assignments":
              html = await renderAssignments();
              break;
            case "grades":
              html = await renderGrades();
              break;
            case "schedule":
              html = await renderSchedule();
              break;
            case "attendance":
              html = await renderAttendance();
              break;
            case "feedback":
              html = await renderFeedback();
              break;
            case "analytics":
              html = await renderAnalytics();
              break;
            case "messages":
              html = await renderMessages();
              break;
            case "settings":
              html = settingsView;
              break;
            case "payments":
              html = await renderPayments();
              break;
            default:
              html = "<h2>Page not found</h2>";
          }
          main.innerHTML = html;

          // Re-attach events based on view
          if (viewName === "messages") attachMessageEvents();
          if (viewName === "settings") attachSettingsEvents();
          if (viewName === "assignments") attachAssignmentEvents();
          if (viewName === "feedback") attachFeedbackEvents();
          if (viewName === "analytics") initAnalyticsCharts();
        } catch (error) {
          console.error("View Error:", error);
          main.innerHTML = `
            <div class="flex flex-col items-center justify-center h-64 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <h3 class="text-xl font-bold">Something went wrong</h3>
                <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded">Reload Page</button>
            </div>`;
        }
      };

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("Current User Data:", currentUser);

        const nameEl = document.getElementById("profile-name");
        const roleEl = document.getElementById("profile-role");
        const imgEl = document.getElementById("profile-img");

        // Use fullName or fallback
        const displayName = currentUser.fullName || currentUser.email || "User";

        if (nameEl) nameEl.textContent = displayName;
        if (roleEl && currentUser.role) roleEl.textContent = currentUser.role;

        if (imgEl) {
          // Generate Avatar
          imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(
            displayName,
          )}&background=6366f1&color=fff`;
        }

        // Initialize Router
        window.switchView("dashboard");

        // Mobile Sidebar Toggle
        document
          .getElementById("sidebarToggle")
          .addEventListener("click", () => {
            document
              .getElementById("sidebar")
              .classList.toggle("-translate-x-full");
          });
      });
    </script>
  </body>
</html>
